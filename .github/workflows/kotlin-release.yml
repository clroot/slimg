name: Kotlin Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 0.1.2)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  resolve-version:
    name: Resolve version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          fi

  build-native:
    name: Build native (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    env:
      SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-latest
            lib: libslimg_ffi.dylib
            resource_dir: darwin-aarch64

          - target: x86_64-apple-darwin
            runner: macos-15-intel
            lib: libslimg_ffi.dylib
            resource_dir: darwin-x86-64

          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            lib: libslimg_ffi.so
            resource_dir: linux-x86-64

          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            lib: libslimg_ffi.so
            resource_dir: linux-aarch64

          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            lib: slimg_ffi.dll
            resource_dir: win32-x86-64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install nasm meson ninja

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y nasm meson ninja-build

      - name: Setup MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Add NASM to PATH (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "C:/Program Files/NASM" >> $GITHUB_PATH

      - name: Install build tools (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          choco install nasm ninja pkgconfiglite -y
          pip install meson

      - name: Force MSVC compiler for meson (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "CC=cl" >> $GITHUB_ENV
          echo "CXX=cl" >> $GITHUB_ENV

      - name: Build
        run: cargo build --release -p slimg-ffi

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.target }}
          path: target/release/${{ matrix.lib }}

  generate-bindings:
    name: Generate Kotlin bindings
    runs-on: macos-latest
    env:
      SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: brew install nasm meson ninja

      - name: Build slimg-ffi
        run: cargo build --release -p slimg-ffi

      - name: Generate Kotlin bindings
        run: |
          cargo run -p slimg-ffi --bin uniffi-bindgen generate \
            --library target/release/libslimg_ffi.dylib \
            --language kotlin \
            --out-dir generated-kotlin

      - name: Patch generated Kotlin for Kotlin 2.x compatibility
        run: |
          chmod +x bindings/scripts/patch-generated-kotlin.sh
          bindings/scripts/patch-generated-kotlin.sh generated-kotlin/io/clroot/slimg/slimg_ffi.kt

      - name: Upload generated Kotlin
        uses: actions/upload-artifact@v4
        with:
          name: kotlin-bindings
          path: generated-kotlin/

  package-and-publish:
    name: Package and publish
    needs: [resolve-version, build-native, generate-bindings]
    runs-on: ubuntu-latest
    env:
      RELEASE_VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          path: native-libs/

      - name: Download generated Kotlin
        uses: actions/download-artifact@v4
        with:
          name: kotlin-bindings
          path: generated-kotlin/

      - name: Arrange native libraries into resources
        run: |
          cp -r generated-kotlin/* bindings/kotlin/src/main/kotlin/

          for target_dir in native-libs/native-*; do
            target=$(basename "$target_dir" | sed 's/native-//')
            case "$target" in
              aarch64-apple-darwin)     res_dir="darwin-aarch64" ;;
              x86_64-apple-darwin)      res_dir="darwin-x86-64" ;;
              x86_64-unknown-linux-gnu) res_dir="linux-x86-64" ;;
              aarch64-unknown-linux-gnu) res_dir="linux-aarch64" ;;
              x86_64-pc-windows-msvc)   res_dir="win32-x86-64" ;;
            esac
            mkdir -p "bindings/kotlin/src/main/resources/$res_dir"
            cp "$target_dir"/* "bindings/kotlin/src/main/resources/$res_dir/"
          done

          echo "=== Bundled native libraries ==="
          find bindings/kotlin/src/main/resources -type f

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Set version
        working-directory: bindings/kotlin
        run: |
          sed -i "s/^version=.*/version=${{ env.RELEASE_VERSION }}/" gradle.properties

      - name: Build and test
        working-directory: bindings/kotlin
        run: ./gradlew build

      - name: Publish to Maven Central
        working-directory: bindings/kotlin
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
        run: ./gradlew publishAndReleaseToMavenCentral

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimg-kotlin-${{ env.RELEASE_VERSION }}
          path: bindings/kotlin/build/libs/*.jar

name: Publish

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v0.3.0)'
        required: true
        type: string

env:
  VERSION: ${{ inputs.tag }}

permissions:
  contents: write
  id-token: write

jobs:
  # ─────────────────────────────────────────────
  # Check if versions are already published
  # ─────────────────────────────────────────────
  check-versions:
    name: Check published versions
    runs-on: ubuntu-latest
    outputs:
      crates-published: ${{ steps.check.outputs.crates }}
      maven-published: ${{ steps.check.outputs.maven }}
      pypi-published: ${{ steps.check.outputs.pypi }}
    steps:
      - id: check
        run: |
          RELEASE_VERSION="${VERSION#v}"

          # Check crates.io
          if curl -sf "https://crates.io/api/v1/crates/slimg/$RELEASE_VERSION" > /dev/null 2>&1; then
            echo "crates=true" >> $GITHUB_OUTPUT
            echo "✅ crates.io: slimg@$RELEASE_VERSION already published"
          else
            echo "crates=false" >> $GITHUB_OUTPUT
            echo "⏳ crates.io: slimg@$RELEASE_VERSION not found, will publish"
          fi

          # Check Maven Central
          MAVEN_URL="https://repo1.maven.org/maven2/io/clroot/slimg/slimg-kotlin/$RELEASE_VERSION/slimg-kotlin-$RELEASE_VERSION.pom"
          if curl -sf "$MAVEN_URL" > /dev/null 2>&1; then
            echo "maven=true" >> $GITHUB_OUTPUT
            echo "✅ Maven Central: slimg-kotlin@$RELEASE_VERSION already published"
          else
            echo "maven=false" >> $GITHUB_OUTPUT
            echo "⏳ Maven Central: slimg-kotlin@$RELEASE_VERSION not found, will publish"
          fi

          # Check PyPI
          if curl -sf "https://pypi.org/pypi/slimg/$RELEASE_VERSION/json" > /dev/null 2>&1; then
            echo "pypi=true" >> $GITHUB_OUTPUT
            echo "✅ PyPI: slimg@$RELEASE_VERSION already published"
          else
            echo "pypi=false" >> $GITHUB_OUTPUT
            echo "⏳ PyPI: slimg@$RELEASE_VERSION not found, will publish"
          fi

  # ─────────────────────────────────────────────
  # Publish to crates.io (slimg-core → slimg)
  # ─────────────────────────────────────────────
  publish-crates:
    name: Publish to crates.io
    needs: [check-versions]
    if: needs.check-versions.outputs.crates-published != 'true'
    runs-on: ubuntu-latest
    env:
      SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y nasm meson ninja-build

      - name: Checkout submodules (for slimg-core dav1d build)
        run: git submodule update --init --recursive

      - name: Publish slimg-libjxl-sys
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # --no-default-features: disable vendored so cmake/bindgen are not needed
          # --no-verify: skip sandbox build (prebuilt archive not available during packaging)
          cargo publish -p slimg-libjxl-sys --no-default-features --no-verify \
            || echo "Already published, skipping"

      - name: Wait for crates.io index (slimg-libjxl-sys)
        run: sleep 30

      - name: Publish slimg-core
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p slimg-core || echo "Already published, skipping"

      - name: Wait for crates.io index
        run: sleep 30

      - name: Publish slimg
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish -p slimg || echo "Already published, skipping"

  # ─────────────────────────────────────────────
  # Publish Homebrew formula to tap repository
  # ─────────────────────────────────────────────
  publish-homebrew:
    name: Publish Homebrew formula
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Wait for release assets and download formula
        run: |
          echo "Waiting for .rb formula asset from release workflow..."
          for i in $(seq 1 30); do
            if gh release download "$VERSION" \
              --repo "${{ github.repository }}" \
              --pattern "*.rb" \
              --dir formula/ 2>/dev/null; then
              echo "Formula downloaded successfully"
              exit 0
            fi
            echo "Attempt $i/30: formula not ready yet, waiting 60s..."
            sleep 60
          done
          echo "::error::Timed out waiting for .rb formula asset"
          exit 1

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: clroot/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cp formula/*.rb homebrew-tap/Formula/

          export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
          brew update
          for rb in homebrew-tap/Formula/*.rb; do
            brew style --except-cops FormulaAudit/Homepage,FormulaAudit/Desc,FormulaAuditStrict --fix "$rb" || true
          done

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          FORMULA_VERSION="${VERSION#v}"
          git add Formula/
          git diff --cached --quiet && echo "Formula already up to date" && exit 0
          git commit -m "slimg ${FORMULA_VERSION}"
          git push

  # ─────────────────────────────────────────────
  # Build native libraries for Kotlin bindings
  # ─────────────────────────────────────────────
  build-kotlin-native:
    name: Build native (${{ matrix.target }})
    needs: [check-versions]
    if: needs.check-versions.outputs.maven-published != 'true'
    runs-on: ${{ matrix.runner }}
    env:
      SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-latest
            lib: libslimg_ffi.dylib
            resource_dir: darwin-aarch64

          - target: x86_64-apple-darwin
            runner: macos-15-intel
            lib: libslimg_ffi.dylib
            resource_dir: darwin-x86-64

          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            lib: libslimg_ffi.so
            resource_dir: linux-x86-64

          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            lib: libslimg_ffi.so
            resource_dir: linux-aarch64

          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            lib: slimg_ffi.dll
            resource_dir: win32-x86-64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install nasm meson ninja

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y nasm meson ninja-build

      - name: Setup MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Add NASM to PATH (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "C:/Program Files/NASM" >> $GITHUB_PATH

      - name: Install build tools (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          choco install nasm ninja pkgconfiglite -y
          pip install meson

      - name: Force MSVC compiler for meson (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "CC=cl" >> $GITHUB_ENV
          echo "CXX=cl" >> $GITHUB_ENV

      - name: Build
        run: cargo build --release -p slimg-ffi

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.target }}
          path: target/release/${{ matrix.lib }}

  # ─────────────────────────────────────────────
  # Generate Kotlin bindings via UniFFI
  # ─────────────────────────────────────────────
  generate-kotlin-bindings:
    name: Generate Kotlin bindings
    needs: [check-versions]
    if: needs.check-versions.outputs.maven-published != 'true'
    runs-on: macos-latest
    env:
      SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: brew install nasm meson ninja

      - name: Build slimg-ffi
        run: cargo build --release -p slimg-ffi

      - name: Generate Kotlin bindings
        run: |
          cargo run -p slimg-ffi --bin uniffi-bindgen generate \
            --library target/release/libslimg_ffi.dylib \
            --language kotlin \
            --out-dir generated-kotlin

      - name: Patch generated Kotlin for Kotlin 2.x compatibility
        run: |
          chmod +x bindings/scripts/patch-generated-kotlin.sh
          bindings/scripts/patch-generated-kotlin.sh generated-kotlin/io/clroot/slimg/slimg_ffi.kt

      - name: Upload generated Kotlin
        uses: actions/upload-artifact@v4
        with:
          name: kotlin-bindings
          path: generated-kotlin/

  # ─────────────────────────────────────────────
  # Package and publish Kotlin bindings to Maven Central
  # ─────────────────────────────────────────────
  publish-kotlin:
    name: Publish Kotlin to Maven Central
    needs: [build-kotlin-native, generate-kotlin-bindings]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          path: native-libs/

      - name: Download generated Kotlin
        uses: actions/download-artifact@v4
        with:
          name: kotlin-bindings
          path: generated-kotlin/

      - name: Arrange native libraries into resources
        run: |
          cp -r generated-kotlin/* bindings/kotlin/src/main/kotlin/

          for target_dir in native-libs/native-*; do
            target=$(basename "$target_dir" | sed 's/native-//')
            case "$target" in
              aarch64-apple-darwin)     res_dir="darwin-aarch64" ;;
              x86_64-apple-darwin)      res_dir="darwin-x86-64" ;;
              x86_64-unknown-linux-gnu) res_dir="linux-x86-64" ;;
              aarch64-unknown-linux-gnu) res_dir="linux-aarch64" ;;
              x86_64-pc-windows-msvc)   res_dir="win32-x86-64" ;;
            esac
            mkdir -p "bindings/kotlin/src/main/resources/$res_dir"
            cp "$target_dir"/* "bindings/kotlin/src/main/resources/$res_dir/"
          done

          echo "=== Bundled native libraries ==="
          find bindings/kotlin/src/main/resources -type f

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Set version
        working-directory: bindings/kotlin
        run: |
          KOTLIN_VERSION="${VERSION#v}"
          sed -i "s/^version=.*/version=${KOTLIN_VERSION}/" gradle.properties

      - name: Build and test
        working-directory: bindings/kotlin
        run: ./gradlew build

      - name: Publish to Maven Central
        working-directory: bindings/kotlin
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
        run: ./gradlew publishAndReleaseToMavenCentral

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: slimg-kotlin-${{ env.VERSION }}
          path: bindings/kotlin/build/libs/*.jar

  # ─────────────────────────────────────────────
  # Build Python wheels for all platforms
  # ─────────────────────────────────────────────
  build-python-wheels:
    name: Build Python wheel (${{ matrix.target }})
    needs: [check-versions]
    if: needs.check-versions.outputs.pypi-published != 'true'
    runs-on: ${{ matrix.runner }}
    env:
      SYSTEM_DEPS_DAV1D_BUILD_INTERNAL: always
    strategy:
      fail-fast: false
      matrix:
        include:
          - { target: aarch64-apple-darwin,        runner: macos-latest }
          - { target: x86_64-apple-darwin,         runner: macos-15-intel }
          - { target: x86_64-unknown-linux-gnu,    runner: ubuntu-latest }
          - { target: aarch64-unknown-linux-gnu,   runner: ubuntu-24.04-arm }
          - { target: x86_64-pc-windows-msvc,      runner: windows-latest }
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install nasm meson ninja

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y nasm meson ninja-build

      - name: Setup MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Add NASM to PATH (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "C:/Program Files/NASM" >> $GITHUB_PATH

      - name: Install build tools (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          choco install nasm ninja pkgconfiglite -y
          pip install meson

      - name: Force MSVC compiler for meson (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "CC=cl" >> $GITHUB_ENV
          echo "CXX=cl" >> $GITHUB_ENV

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist
          working-directory: bindings/python

      - uses: actions/upload-artifact@v4
        with:
          name: python-wheels-${{ matrix.target }}
          path: bindings/python/dist/*.whl

  # ─────────────────────────────────────────────
  # Build Python source distribution
  # ─────────────────────────────────────────────
  build-python-sdist:
    name: Build Python sdist
    needs: [check-versions]
    if: needs.check-versions.outputs.pypi-published != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
          working-directory: bindings/python

      - uses: actions/upload-artifact@v4
        with:
          name: python-wheels-sdist
          path: bindings/python/dist/*.tar.gz

  # ─────────────────────────────────────────────
  # Verify Python version matches release tag
  # ─────────────────────────────────────────────
  verify-python-version:
    name: Verify Python package version
    needs: [check-versions]
    if: needs.check-versions.outputs.pypi-published != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check version consistency
        shell: bash
        run: |
          RELEASE_VERSION="${VERSION#v}"
          PKG_VERSION=$(python3 -c "
          import tomllib
          with open('bindings/python/pyproject.toml', 'rb') as f:
              print(tomllib.load(f)['project']['version'])
          ")
          if [ "$RELEASE_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Version mismatch: release tag=$RELEASE_VERSION, pyproject.toml=$PKG_VERSION"
            exit 1
          fi
          echo "Version verified: $RELEASE_VERSION"

  # ─────────────────────────────────────────────
  # Smoke test built Python wheels
  # ─────────────────────────────────────────────
  smoke-test-python:
    name: Smoke test Python wheel (${{ matrix.os }})
    needs: [build-python-wheels]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - uses: actions/download-artifact@v4
        with:
          pattern: python-wheels-*
          path: dist/
          merge-multiple: true

      - name: Install and smoke test
        shell: bash
        run: |
          pip install --find-links dist/ --no-index slimg
          python -c "
          import slimg
          print('Format:', slimg.Format.PNG)
          print('Extension:', slimg.Format.PNG.extension)
          print('Can encode:', slimg.Format.JPEG.can_encode)
          # Create a small test image and round-trip it
          data = bytes(4 * 4 * 4)  # 4x4 RGBA black
          img = slimg.Image(4, 4, data)
          result = slimg.convert(img, 'png')
          assert len(result.data) > 0, 'PNG encode failed'
          print('Smoke test passed!')
          "

  # ─────────────────────────────────────────────
  # Publish Python package to PyPI
  # ─────────────────────────────────────────────
  publish-python:
    name: Publish to PyPI
    needs: [build-python-wheels, build-python-sdist, verify-python-version, smoke-test-python]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: python-wheels-*
          path: dist/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: python-wheels-sdist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
